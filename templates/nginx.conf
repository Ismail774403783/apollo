server {
    listen  80;
    server_name ${opts:server_name};
    access_log  ${opts:access_log};
    error_log   ${opts:error_log};

    rewrite ^ https://$server_name$request_uri? permanent;
}
server {
    listen 443;
    server_name ${opts:server_name};
    access_log  ${opts:access_log};
    error_log   ${opts:error_log};

    ssl on;
    ssl_certificate ${opts:control-script}.crt;
    ssl_certificate_key ${opts:control-script}.key;
    ssl_session_cache    shared:SSL:10m;
    ssl_session_timeout  10m;
    ssl_ciphers ALL:!kEDH!ADH:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;

    location ^~ /media/ {
        root ${opts:media_dir};
        expires 31d;
    }

    location ^~ /assets/ {
        root ${opts:static_dir};
        expires 31d;
        if ($request_uri ~* \.(ico|css|js|gif|jpe?g|png)$) {
            access_log off;
            expires max;
            add_header Cache-Control public;
        }
    }

    location / {
        uwsgi_pass unix:${opts:socketfile};
        uwsgi_read_timeout 180;
        include /etc/nginx/uwsgi_params;
    }

    gzip on;
    gzip_http_version 1.1;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_proxied any;
    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

    # make sure gzip does not lose large gzipped js or css files
    # see http://blog.leetsoft.com/2007/7/25/nginx-gzip-ssl
    gzip_buffers 16 8k;

    # Disable gzip for certain browsers.
    gzip_disable "MSIE [1-6].(?!.*SV1)";
}

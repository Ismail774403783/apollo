{%- extends 'frontend/_layout.html' -%}
{%- from 'frontend/macros/analysis_breadcrumb.html' import render_analysis_breadcrumb -%}
{%- block content -%}
<div class="row">
	<div class="col-md-9">{{ render_analysis_breadcrumb(breadcrumb_data) }}</div>
	<div class="col-md-3">
		<form class="form-inline pull-right" method="GET" accept-charset="utf-8">
			<div class="form-group form-container">{{ filter_form.sample(class_='form-control span2 input-sm') }}</div>
			<button class="btn btn-warning btn-sm" type="submit"><i class="glyphicon glyphicon-search"></i> {% trans %}Filter{% endtrans %}</button>
		</form>
	</div>
</div>
<div class="row">
  <div class="col-md-12">
    <div id="container" style="height: 300px; min-width: 600px" data-chart='{{ chart_data|tojson }}'></div>
  </div>
</div>
<div class="row">
	<div class="col-md-12">
		<ul class="nav nav-tabs">
			{%- for lt in location_types -%}
			<li{%- if loop.first %} class="active"{%- endif -%}><a href="#tab_{{ loop.index }}" data-toggle="tab">{{ lt.name }}</a></li>
			{%- endfor -%}
		</ul>
		<div class="tab-content" style="overflow:auto;">
			{%- for lt in location_types -%}
			<div class="tab-pane{%- if loop.first %} active{%- endif -%}" id="tab_{{ loop.index }}">
				{%- if result_labels -%}
				<table class="table-responsive">
					<table class="table table-bordered table-hover">
						<tr>
							<th width="200" rowspan="2" style="vertical-align:middle" class="gray">&nbsp;</th>
							<th class="gray">&nbsp;</th>
							<th class="gray">&nbsp;</th>
							{%- if form.registered_voters_tag -%}
							<th class="gray">&nbsp;</th>
							{%- endif -%}
							<th width="30"{% if form.registered_voters_tag and form.calculate_moe and config.ENABLE_MOE %} colspan="3"{%- endif -%} class="gray" style="text-align:center">{%- trans -%}Total votes{%- endtrans -%}</th>
							<th width="100"{% if form.calculate_moe and config.ENABLE_MOE %} colspan="3"{%- endif -%} class="gray" style="text-align:center">{%- trans -%}Rejected ballots{%- endtrans -%}</th>
							<th width="30" class="gray" style="text-align:center">{%- trans -%}Total valid{%- endtrans -%}</th>
							{%- for party in result_descriptions -%}
							<th width="100"{%- if form.calculate_moe and config.ENABLE_MOE %} colspan="3"{%- endif -%} class="gray" style="text-align:center">{{ party }}</th>
							{%- endfor -%}
						</tr>
						<tr>
							<td class="centered" width="10%"><em>{%- trans -%}Reported{%- endtrans -%}</em></td>
							<td class="centered" width="10%"><em>{%- trans -%}Missing{%- endtrans -%}</em></td>
							{%- if form.registered_voters_tag -%}
							<td class="centered"><em><abbr title="{%- trans -%}Total registered{%- endtrans -%}">{%- trans -%}TR{%- endtrans -%}</abbr></em></td>
							{%- endif -%}
							<td class="centered" width="10%">{%- trans -%}Votes{%- endtrans -%}</td>
							{%- if form.registered_voters_tag and form.calculate_moe and config.ENABLE_MOE -%}
							<td class="centered"><em><abbr title="{%- trans -%}Margin of error{%- endtrans -%}">{%- trans -%}MoE 95%{%- endtrans -%}</abbr></em></td>
							<td class="centered"><em><abbr title="{%- trans -%}Margin of error{%- endtrans -%}">{%- trans -%}MoE 99%{%- endtrans -%}</abbr></em></td>
							{%- endif -%}
							<td class="centered"><em><abbr title="{%- trans -%}Rejected ballots{%- endtrans -%}">{%- trans -%}RB{%- endtrans -%}</abbr></em></td>
							{%- if form.calculate_moe and config.ENABLE_MOE -%}
							<td class="centered"><em><abbr title="{%- trans -%}Margin of error{%- endtrans -%}">{%- trans -%}MoE 95%{%- endtrans -%}</abbr></em></td>
							<td class="centered"><em><abbr title="{%- trans -%}Margin of error{%- endtrans -%}">{%- trans -%}MoE 99%{%- endtrans -%}</abbr></em></td>
							{%- endif -%}
							<td class="centered"><em><abbr title="{%- trans -%}Total valid{%- endtrans -%}">{%- trans -%}TV{%- endtrans -%}</abbr></em></td>
							{%- for party in result_descriptions -%}
							<td class="centered"><em>{%- trans -%}Votes{%- endtrans -%}</em></td>
							{%- if form.calculate_moe and config.ENABLE_MOE -%}
							<td class="centered"><em><abbr title="{%- trans -%}Margin of error{%- endtrans -%}">{%- trans -%}MoE 95%{%- endtrans -%}</abbr></em></td>
							<td class="centered"><em><abbr title="{%- trans -%}Margin of error{%- endtrans -%}">{%- trans -%}MoE 99%{%- endtrans -%}</abbr></em></td>
							{%- endif -%}
							{%- endfor -%}
						</tr>
                        {% with df = dataframe.ix[dataframe.groupby(location.location_type).groups[location.name]] %}
						<tr>
							<th class="gray" style="vertical-align:middle">{{ location.name }} &middot; <span class="muted"><em>{{ location.location_type }}</em></span></th>
							<th class="numeric gray">{{ df|reported_pct(result_labels) }}% <br>({{ df|reported(result_labels) }})</th>
							<th class="numeric gray">{{ df|missing_pct(result_labels) }}% <br>({{ df|missing(result_labels) }})</th>
							{%- if form.registered_voters_tag -%}
							<th class="numeric gray">{{ df|total_registered(form) }}</th>
							{%- endif -%}
							<th class="numeric gray">{{ df|all_votes_total_pct(form, result_labels) }}% ({{ df|all_votes_total(form, result_labels) }})</th>
							{%- if form.registered_voters_tag and form.calculate_moe and config.ENABLE_MOE -%}
							<th class="numeric gray">{{ df|all_votes_total_moe(form, result_labels) }}%</th>
							<th class="numeric gray">{{ df|all_votes_total_moe(form, result_labels, 258.0) }}%</th>
							{%- endif -%}
							<th class="numeric gray">{{ df|rejected_proportion(form) }}%<br />({{ df|rejected_count(form) }})</th>
                            {%- if form.calculate_moe and config.ENABLE_MOE -%}
                            <th class="numeric gray">{{ df|rejected_moe(form) }}%</th>
                            <th class="numeric gray">{{ df|rejected_moe(form, 258.0) }}%</th>
                            {%- endif -%}
                            <th class="numeric gray">{{ df|valid_votes_total(result_labels) }}</th>
                            {%- for vote in result_labels -%}
                            <th class="numeric gray">{{ df|vote_proportion(form, result_labels, vote) }}%<br />({{ df|vote_count(result_labels, vote) }})</th>
                            {%- if form.calculate_moe and config.ENABLE_MOE -%}
                            <th class="numeric gray">{{ df|vote_moe(form, result_labels, vote) }}%</th>
                            <th class="numeric gray">{{ df|vote_moe(form, result_labels, vote, 258.0) }}%</th>
                            {%- endif -%}
                            {%- endfor -%}
						</tr>
                        {% endwith %}
						{%- for sublocation in location_tree[lt.name] -%}
                        {% with df = dataframe.ix[dataframe.groupby(sublocation.location_type).groups[sublocation.name]] %}
						<tr>
							<td class="gray" style="vertical-align:middle">{{ sublocation.name }} &middot; <span class="muted"><em>{{ sublocation.location_type }}</em></span></td>
							<th class="numeric gray">{{ df|reported_pct(result_labels) }}% <br>({{ df|reported(result_labels) }})</th>
							<th class="numeric gray">{{ df|missing_pct(result_labels) }}% <br>({{ df|missing(result_labels) }})</th>
							{%- if form.registered_voters_tag -%}
							<th class="numeric gray">{{ df|total_registered(form) }}</th>
							{%- endif -%}
							<th class="numeric gray">{{ df|all_votes_total_pct(form, result_labels) }}% ({{ df|all_votes_total(form, result_labels) }})</th>
							{%- if form.registered_voters_tag and form.calculate_moe and config.ENABLE_MOE -%}
							<th class="numeric gray">{{ df|all_votes_total_moe(form, result_labels) }}%</th>
							<th class="numeric gray">{{ df|all_votes_total_moe(form, result_labels, 258.0) }}%</th>
							{%- endif -%}
							<th class="numeric gray">{{ df|rejected_proportion(form) }}%<br />({{ df|rejected_count(form) }})</th>
                            {%- if form.calculate_moe and config.ENABLE_MOE -%}
                            <th class="numeric gray">{{ df|rejected_moe(form) }}%</th>
                            <th class="numeric gray">{{ df|rejected_moe(form, 258.0) }}%</th>
                            {%- endif -%}
                            <th class="numeric gray">{{ df|valid_votes_total(result_labels) }}</th>
                            {%- for vote in result_labels -%}
                            <th class="numeric gray">{{ df|vote_proportion(form, result_labels, vote) }}%<br />({{ df|vote_count(result_labels, vote) }})</th>
                            {%- if form.calculate_moe and config.ENABLE_MOE -%}
                            <th class="numeric gray">{{ df|vote_moe(form, result_labels, vote) }}%</th>
                            <th class="numeric gray">{{ df|vote_moe(form, result_labels, vote, 258.0) }}%</th>
                            {%- endif -%}
                            {%- endfor -%}
						</tr>
                        {% endwith %}
						{%- endfor -%}
					</table>
				</table>
				{%- else -%}
				<table width="100%" class="table table-striped table-bordered">
                    <tr class="warning"><td style="text-align:center">{% trans %}No Data Available{% endtrans %}</td></tr>
                </table>
				{%- endif -%}
			</div>
			{%- endfor -%}
		</div>
	</div>
</div>
{%- endblock -%}
{% block scripts %}
<script src="{{ url_for('static', filename='js/moment-with-langs.min.js') }}"></script>
<script type="text/javascript">
  moment.lang('{{ g.locale }}');
  $(function () {
    // load the data
    var data = $('#container').data('chart');

    Highcharts.setOptions({
      global: {
        useUTC: false
      }
    });

    // Create the chart
    $('#container').highcharts('StockChart', {
        rangeSelector : {
            enabled : false
        },
        title: {
            text: "{% trans %}Convergence Chart{% endtrans %}"
        },
        navigator: {
            height: 30,
            margin: 10
        },
        credits: {
            enabled: false
        },
        exporting: {
            enabled: false
        },
        scrollbar : {
            enabled : false
        },
        legend: {
            enabled: true
        },
        series : [
{% for series in chart_series %}
        {
            name : '{{ series }}',
            data : data.{{ series }},
            type: 'line',
            dataLabels: {
                format: '{y}%%'
            },
            tooltip: {
                valueDecimals: 1
            }
        },
{% endfor %}
        ],

        yAxis: {
            min: 0,
            labels: {
                formatter: function() {
                    return this.value + '%';
                }
            },
            gridLineColor: "#DDD"
        },
        tooltip: {
            valueSuffix: '%',
            headerFormat: '<small>{point.key}</small><table>',
            pointFormat: '<tr><td style="color: {series.color}">{series.name}:</td>' +
                '<td style="text-align: right"><b>{point.y}</b></td></tr>',
            shadow: false,
            footerFormat: '</table>',
            useHTML: true,
        }
    });
  });
</script>
<script src="{{ url_for('static', filename='js/timestamps.js') }}"></script>
<script src="{{ url_for('static', filename='js/highstock.js') }}"></script>
{% endblock %}

{% extends "core/layout.html" %}
{% load apollo %}
{% block content %}
<div class="row">
	<div class="span9">
		{% analysis_breadcrumb_navigation form location display_tag %}
	</div>
	<div class="span3">
		<form class="form-horizontal pull-right" action="" method="get" accept-charset="utf-8">
          {{ filter_form.sample }}
          <button class="btn btn-warning" type="submit"><i class="icon-search icon-white"></i> Filter</button>
        </form>
	</div>
    <div class="span12">
        {% analysis_location_navigation form location display_tag %}
    </div>
</div>
<div class="row">
	<div class="span12">
		<div class="tabbable tabs-right"> <!-- Only required for left/right tabs -->
		  <ul class="nav nav-tabs">
		    <li class="active"><a href="#table" data-toggle="tab">Table</a></li>
		    <li><a href="#charts" data-toggle="tab">Charts</a></li>
		  </ul>
		  <div class="tab-content">
		    <div class="tab-pane active" id="table">
		    	{% for tag, question, tag_stats in process_summary.top %}
					<table id="mytable" class="table table-bordered table-striped">
						<tr>
							<td colspan="{% if tag_stats.type == 'numeric' %}4{% else %}{{ tag_stats.labels|length|add:'3' }}{% endif %}"><strong>{{ tag }}</strong> · {{ question }}</td>
						</tr>
						<tr>
							<th></th>
							{% if tag_stats.type == 'numeric' %}
							<th width="80">Mean</th>
							{% else %}
							{% for label in tag_stats.labels %}
							<th>{{ label }}</th>
							{% endfor %}
							{% endif %}
							<th width="80">Reported</th>
							<th width="80">Missing</th>
						</tr>
						<tr>
							<td><strong>{{ location }}</strong></td>
							{% if tag_stats.type == 'numeric' %}
							<td align="right">{{ tag_stats.mean|floatformat:0 }}</td>
							{% else %}
							{% for value, percentage in tag_stats.histogram %}
							<td>{{ percentage|floatformat:0 }}% ({{ value }})</td>
							{% endfor %}
							{% endif %}
							<td align="right">{{ tag_stats.percent_reported|floatformat:0 }}% ({{ tag_stats.reported }})</td>
							<td align="right">{{ tag_stats.percent_missing|floatformat:0 }}% ({{ tag_stats.missing }})</td>
						</tr>
						{% for location_type, location_type_summary in process_summary.groups %}
						{% for tag, question, tag_stats in location_type_summary %}
						{% for location in tag_stats.locations.keys|sortedlist %}
                        {% with tag_stats.locations|keyvalue:location as location_stats %}
						<tr>
							<td><span style="margin-left:2em">{{ location }} · <span class="muted"><em>{{ location_type }}</em></span></span></td>
							{% if tag_stats.type == 'numeric' %}
							<td align="right">{{ location_stats.mean|floatformat:0 }}</td>
							{% else %}
							{% for value, percentage in location_stats.histogram %}
							<td>{{ percentage|floatformat:0 }}% ({{ value }})</td>
							{% endfor %}
							{% endif %}
							<td align="right">{{ location_stats.percent_reported|floatformat:0 }}% ({{ location_stats.reported }})</td>
							<td align="right">{{ location_stats.percent_missing|floatformat:0 }}% ({{ location_stats.missing }})</td>
						</tr>
                        {% endwith %}
						{% endfor %}
						{% endfor %}
						{% endfor %}
					</table>	
				{% endfor %}
		    </div>

		    <!-- Charts Section-->
		    <div class="tab-pane" id="charts">
{% for tag, question, tag_stats in process_summary.top %}
		      <table class="table table-bordered table-striped">
			        <tr>
			            <td colspan="2"><strong>{{ tag }}</strong> · {{ question }}</td>
			        </tr>
{% for tag, question, tag_stats in process_summary.top %}
	{% if tag_stats.type == 'single-choice' %}
			        <tr>
			        	<td>
<script type="text/javascript+protovis">
	var legend = [{% for label in tag_stats.labels %}"{{ label }}",{% endfor %}];
	var data = [{% for value, percentage in tag_stats.histogram %}[{{ percentage }}],{% endfor %}];
	var labels = ["{{ location }}"];

{% for location_type, location_type_summary in process_summary.groups %}
  {% for tag, question, tag_stats in location_type_summary %}
    {% for location in tag_stats.locations.keys|sortedlist %}
    {% with tag_stats.locations|keyvalue:location as location_stats %}
	labels.push("{{ location }}");
	{% for value, percentage in location_stats.histogram %}data[{{forloop.counter0}}].push({{ percentage }});
	{% endfor %}
    {% endwith %}
    {% endfor %}
  {% endfor %}
{% endfor %}

	colors = [ '#FC6C00','#FFBD70',"#E1E4CB",'#A6DAD8',"#65D1E8"];

	bar_height = 25,
	bar_spacing = 15,
	bar_width = 300;
	
	left_margin = 200;

	height = (bar_height + bar_spacing) * data[0].length + (bar_height * 1.5);
	width = left_margin + bar_width + 200;
	
	
	label_margin = (bar_height - 10) / 2;
	

	var vis = new pv.Panel().width(width).height(height);
	bar = vis.add(pv.Layout.Stack)
		.layers(data)
		.orient("left")
		.left(left_margin)
		.top(height)
		.x(function() height - ((this.index ? this.index + 1.5 : 1) * (bar_height + bar_spacing)))
		.y(function(d) d / 100 * bar_width)
		.layer.add(pv.Bar).height(bar_height)
		.fillStyle(function() colors[this.parent.index])
		.anchor("bottom")
	    .add(pv.Label)
			.textBaseline("bottom")
			.text(function(d){ return (d) ? Math.round(d) + "%" : ""})
			.textMargin(label_margin)
			.font('9pt sans-serif');

	vis.add(pv.Label)
		.data(labels)
		.left(left_margin)
		.textAlign('right')
		.top(function() ((this.index ? this.index + 1.5 : 1) * (bar_height + bar_spacing)))
		.textMargin(label_margin)
		.font('10pt sans-serif');

	// Legends  
	vis.add(pv.Dot) 
		.data(legend) 
		.top(function() (height - (20 * legend.length)) / 2 + (this.index * 20))
		.left(left_margin + bar_width + 30) 
		.size(40) 
		.strokeStyle(null) 
		.fillStyle(pv.colors(colors)) 
		.anchor("right").add(pv.Label)
		.textMargin(8);

	vis.render();
</script>
	</td>
	<td>            
<script type="text/javascript+protovis">
    width = 300,
    top_margin = 20,
    height = 350,
    offset = 10,
    radius = 100,
    diameter = radius * 2;
    data = [{{ tag_stats.percent_missing|floatformat:0 }}/100, {{ tag_stats.percent_reported|floatformat:0 }}/100];
    colors = ["#FF5200","#39e639"];
    labels = ["Missing", "Reported"];

    var pie = new pv.Panel().width(width).height(height);
        pie.add(pv.Wedge)
        .data(pv.normalize(data))
        .outerRadius(radius)
        .angle(function(d) d * 2 * Math.PI)
        .left(width / 2)
        .top(radius + top_margin)
        .fillStyle(pv.colors(colors).by(function () { return this.index;}))
        .anchor("center")
        .add(pv.Label)
        .textAngle(0)
        .text(function(d){ return (d) ? (d*100).toFixed(0) + "%": ""})
        .font('20pt sans-serif');
        
    //legends   
    pie.add(pv.Dot) 
        .data(labels) 
        .top(function() diameter + (top_margin * 4) + (this.index * 30))
        .left(width / 2 - radius / 4) 
        .size(80) 
        .strokeStyle(null) 
        .fillStyle(pv.colors(colors)) 
        .anchor("right").add(pv.Label)
        .textMargin(8)
        .font('12pt sans-serif');
        
    pie.render();
</script>
			            </td>
			        </tr>
	{% elif tag_stats.type == 'multiple-choice' %}
			        <tr>
			        	<td>
<script type="text/javascript+protovis">
	var data = [[{% for value, percentage in tag_stats.histogram %}{{ percentage }},{% endfor %}]];
	var labels = ["{{ location }}"];
	var legend = [{% for label in tag_stats.labels %}"{{ label|safe }}",{% endfor %}];

	{% for location_type, location_type_summary in process_summary.groups %}
	  {% for tag, question, tag_stats in location_type_summary %}
        {% for location in tag_stats.locations.keys|sortedlist %}
        {% with tag_stats.locations|keyvalue:location as location_stats %}
		labels.push("{{ location }}");
		data.push([{% for value, percentage in location_stats.histogram %}{{ percentage }},{% endfor %}]);
	    {% endwith %}
        {% endfor %}
	  {% endfor %}
	{% endfor %}

	var colors = ['#FC6C00','#FFBD70','#E1E4CB','#A6DAD8','#65D1E8'];
	

var n = data.length, m = data[0].length;

/* Sizing and scales. */
var w = 500,
	bar_width = 300,
	bar_height = 25,
	margin_left = 200,
    h = ((data[0].length * bar_height) + bar_height) * data.length,
    max_value = pv.max(pv.blend(data)),

    x = pv.Scale.linear(0, 100).range(0, bar_width),
    x_rule = pv.Scale.linear(0, 100).range(margin_left, bar_width + margin_left),
    y = pv.Scale.ordinal(pv.range(n)).splitBanded(0, h, 4/5);

/* The root panel. */
var vis = new pv.Panel()
    .width(w+margin_left)
    .bottom(bar_height)
    .height(h);

/* The bars. */
var bar = vis.add(pv.Panel)
    .data(data)
    .left(margin_left)
    .top(function() y(this.index))
    .height(y.range().band)
  .add(pv.Bar)
    .data(function(d) d)
    .top(function() this.index * y.range().band / m)
    .height(y.range().band / m)
    .left(0)
    .width(x)
    .strokeStyle('white')
    .fillStyle(pv.colors(colors).by(pv.index));

/* The value label. */
bar.anchor(function (d) d < 13 ? "left" : "right").add(pv.Label)
	.textMargin(5)
    .text(function(d) d.toFixed(0) + '%');

/* The variable label. */
bar.parent.anchor("left").add(pv.Label)
    .textAlign("right")
    .textMargin(5)
    .font('10pt sans-serif')
    .text(function () labels[this.parent.index]);

/* legend */
bar.parent
	.add(pv.Dot) 
    .data(legend)
    .left(bar_width + 50)
    .top(function() this.index * 20 + (((data[0].length * bar_height) - (20 * data[0].length))) / 2)
    .size(20)
    .strokeStyle(null) 
    .fillStyle(pv.colors(colors)) 
    .anchor("right").add(pv.Label);

/* X-axis ticks. */
vis.add(pv.Rule)
    .data(x_rule.ticks(5))
    .left(x_rule)
    .strokeStyle(function(d) d ? "rgba(255,255,255,.3)" : "null")
  .add(pv.Rule)
    .bottom(0)
    .height(5)
    .strokeStyle("#000")
  .anchor("bottom").add(pv.Label)
    .text(function (d) x_rule.tickFormat(d) + '%');

vis.render();

</script>
			            </td>
			            </td>
	<td>            
<script type="text/javascript+protovis">
    width = 300,
    top_margin = 20,
    height = 350,
    offset = 10,
    radius = 100,
    diameter = radius * 2;
    data = [{{ tag_stats.percent_missing|floatformat:0 }}/100, {{ tag_stats.percent_reported|floatformat:0 }}/100];
    colors = ["#FF5200","#39e639"];
    labels = ["Missing", "Reported"];

    var pie = new pv.Panel().width(width).height(height);
        pie.add(pv.Wedge)
        .data(pv.normalize(data))
        .outerRadius(radius)
        .angle(function(d) d * 2 * Math.PI)
        .left(width / 2)
        .top(radius + top_margin)
        .fillStyle(pv.colors(colors).by(function () { return this.index;}))
        .anchor("center")
        .add(pv.Label)
        .textAngle(0)
        .text(function(d){ return (d) ? (d*100).toFixed(0) + "%": ""})
        .font('20pt sans-serif');
        
    //legends   
    pie.add(pv.Dot) 
        .data(labels) 
        .top(function() diameter + (top_margin * 4) + (this.index * 30))
        .left(width / 2 - radius / 4) 
        .size(80) 
        .strokeStyle(null) 
        .fillStyle(pv.colors(colors)) 
        .anchor("right").add(pv.Label)
        .textMargin(8)
        .font('12pt sans-serif');
        
    pie.render();
</script>
			            </td>
				    </tr>
	{% elif tag_stats.type == 'numeric' %}
			        <tr>
			        	<td>
<script type="text/javascript+protovis">
	var data = [{{ tag_stats.mean|floatformat:0 }}, 0];
	var labels = ["{{ location }}", ""];
	var legend = ['Mean']

	{% for location_type, location_type_summary in process_summary.groups %}
	  {% for tag, question, tag_stats in location_type_summary %}
        {% for location in tag_stats.locations.keys|sortedlist %}
        {% with tag_stats.locations|keyvalue:location as location_stats %}
		labels.push("{{ location }}");
		data.push({{ location_stats.mean|floatformat:0 }})
	    {% endwith %}
        {% endfor %}
	  {% endfor %}
	{% endfor %}

	var colors = ['#FC6C00'];
	

var n = data.length, m = data.length;

/* Sizing and scales. */
var w = 500,
	bar_width = 300,
	bar_height = 25,
	margin_left = 200,
    h = n * bar_height,
    max_value = pv.max(data),

    x = pv.Scale.linear(0, max_value).range(0, bar_width),
    x_rule = pv.Scale.linear(0, max_value).range(margin_left, bar_width + margin_left),
    y = pv.Scale.ordinal(pv.range(n)).splitBanded(0, h, 1);

/* The root panel. */
var vis = new pv.Panel()
    .width(w+margin_left)
    .top(bar_height)
    .bottom(bar_height)
    .height(h + bar_height);

/* The bars. */
var bar = vis.add(pv.Bar)
	.data(data)
  	.left(margin_left)
    .top(function() this.index * y.range().band)
    .height(y.range().band)
    .width(x)
    .strokeStyle('white')
    .fillStyle(pv.colors(colors).by(pv.index));

/* The value label. */
bar.anchor("right").add(pv.Label)
	.textMargin(5)
    .text(function(d) d ? d.toFixed(0) : "");

/* The variable label. */
bar.anchor("left").add(pv.Label)
    .textAlign("right")
    .textMargin(5)
    .font('10pt sans-serif')
    .text(function () labels[this.index]);

/* legend */
bar.parent
	.add(pv.Dot) 
    .data(legend)
    .left(bar_width + margin_left + 50)
    .top(function() ((data.length * bar_height) - 20) / 2)
    .size(20)
    .strokeStyle(null) 
    .fillStyle(pv.colors(colors)) 
    .anchor("right").add(pv.Label);

/* X-axis ticks. */
vis.add(pv.Rule)
    .data(x_rule.ticks(5))
    .left(x_rule)
    .strokeStyle(function(d) d ? "rgba(255,255,255,.3)" : "null")
  .add(pv.Rule)
    .bottom(0)
    .height(5)
    .strokeStyle("#000")
  .anchor("bottom").add(pv.Label)
    .text(function (d) x_rule.tickFormat(d));

vis.render();

</script>
			            </td>
			            </td>
	<td>            
<script type="text/javascript+protovis">
    width = 300,
    top_margin = 20,
    height = 350,
    offset = 10,
    radius = 100,
    diameter = radius * 2;
    data = [{{ tag_stats.percent_missing|floatformat:0 }}/100, {{ tag_stats.percent_reported|floatformat:0 }}/100];
    colors = ["#FF5200","#39e639"];
    labels = ["Missing", "Reported"];

    var pie = new pv.Panel().width(width).height(height);
        pie.add(pv.Wedge)
        .data(pv.normalize(data))
        .outerRadius(radius)
        .angle(function(d) d * 2 * Math.PI)
        .left(width / 2)
        .top(radius + top_margin)
        .fillStyle(pv.colors(colors).by(function () { return this.index;}))
        .anchor("center")
        .add(pv.Label)
        .textAngle(0)
        .text(function(d){ return (d) ? (d*100).toFixed(0) + "%": ""})
        .font('20pt sans-serif');
        
    //legends   
    pie.add(pv.Dot) 
        .data(labels) 
        .top(function() diameter + (top_margin * 4) + (this.index * 30))
        .left(width / 2 - radius / 4) 
        .size(80) 
        .strokeStyle(null) 
        .fillStyle(pv.colors(colors)) 
        .anchor("right").add(pv.Label)
        .textMargin(8)
        .font('12pt sans-serif');
        
    pie.render();
</script>
			            </td>
				    </tr>
	{% endif %}
{% endfor %}
			</table>
{% endfor %}
		    </div>
		  </div>
		</div>
	</div>
</div>
{% endblock %}

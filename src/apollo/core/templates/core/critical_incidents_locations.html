{% extends "core/layout.html" %}
{% load apollo %}{% load static %}
{% block title %}
{{ page_title }}
{% if perms.core.export_submissions %}
<div class="btn-group pull-right">
  <form method="get"><input type="hidden" name="export" value="true" /><button class="btn" type="submit">Export</a></form>
</div>
{% endif %}
{% endblock %}
{% block content %}
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCk3QNCVPzkE75lgmHt_iOM4v0x2ZU-swI&sensor=false"></script>
  <script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/src/markerclusterer.js"></script>
  <script type="text/javascript">
      $(document).ready(function(){
      });
      var initialized = false;
      function init() {
        if (!initialized) {
            initialize();
        }
        initialize = true;
      }
  </script>
<div class="row">
	<div class="span5">
		{% analysis_breadcrumb_navigation form location %}
  	</div>
  	<div class="span7">
        <form class="form-horizontal pull-right" action="" method="post" accept-charset="utf-8">
          {% csrf_token %}
          {{ filter_form.status }} {{ filter_form.witness }} {{ filter_form.sample }}
          <button class="btn btn-warning" type="submit"><i class="icon-search icon-white"></i> Filter</button>
        </form>
  	</div>
    <div class="span12">
        {% analysis_location_navigation form location %}
    </div>
 </div>
 <div class="row">
	<div class="span12">
		{% if incidents %}
		<div class="tabbable"> <!-- Only required for left/right tabs -->
			<ul class="nav nav-tabs">
				<li class="active"><a href="#tab1" data-toggle="tab">Table</a></li>
				<li><a href="#tab2" data-toggle="tab" onclick="init();">Map</a></li>
			</ul>
			<div class="tab-content">
			    <div class="tab-pane active" id="tab1">
<table class="table table-bordered table-striped">
    <tr>
        <td colspan="5"><strong>{{ form_field.tag }}</strong> · {{ form_field.description }}</td>
    </tr>
	<tr>
        <th>Name</th>
		<th>Location</th>
        <th style="text-align: center">Witnessed</th>
        <th style="text-align: center" width="50">Status</th>
		<th>Description</th>
	</tr>
    {% for incident in incidents %}
	<tr>
        <td>{{ incident.observer.name }}</td>
        <td>{{ incident.location }} · <em class="muted">{{ incident.location.type }}</em></td>
        <td style="text-align: center">
        {% with incident.data.witness as witness %}
        {% if witness == 'witnessed' %}
            <i class="icon-eye-open" title="Witnessed incident"></i>
        {% elif witness == 'after' %}
            <i class="icon-eye-close" title="Arrived after incident"></i>
        {% elif witness == 'reported' %}
            <i class="icon-user" title="Incident was reported"></i>
        {% else %}
            &nbsp;
        {% endif %}
        {% endwith %}
        </td>
        <td style="text-align: center">
        {% with incident.data.status as status %}
        {% if status == 'confirmed' %}
        <img src="{% static "img/tick.png" %}" title="Confirmed" alt="Confirmed" />
        {% elif status == 'rejected' %}
        <img src="{% static "img/red_dot.png" %}" title="Rejected" alt="Rejected" />
        {% else %}
        <img src="{% static "img/caution.png" %}" title="Unmarked" alt="Unmarked" />
        {% endif %}
        {% endwith %}
        </td>
		<td>{{ incident.data.description }}</td>
	</tr>
    {% endfor %}
</table>
				</div>
				<!--Map-->
				<div class="tab-pane" id="tab2">
                    <p>
                        Province <input type="checkbox" id="layer0" onclick="toggleLevels(0)" checked>
                        District <input type="checkbox" id="layer1" onclick="toggleLevels(1)" checked>
                    </p>
                    <div id="map_canvas" style="width:100%; height:450px;"></div>
                    <script type="text/javascript">
                        var map; 
                        var levels = [];

                        function initialize() {
                          var zim = new google.maps.LatLng (-19, 27);
                          var myOptions = {
                            zoom: 6,
                            center: zim,
                            mapTypeId: google.maps.MapTypeId.ROADMAP
                              }
                            map = new google.maps.Map(document.getElementById("map_canvas"),
                              myOptions);
                            marker = new google.maps.Marker({map:map});

                            levels[0] = new google.maps.KmlLayer('http://geocommons.com/overlays/798.kml', {preserveViewport: true});
                            levels[1] = new google.maps.KmlLayer('http://geocommons.com/overlays/156552.kml', {preserveViewport: true});
                            for (var i = 0; i < levels.length; i++) {
                              levels[i].setMap(map);
                            }
                            var markers = [];

                            for (i = 0; i < 100; i++) {
                              markers.push(new google.maps.Marker({
                                position: new google.maps.LatLng(-17.49, 31.3),
                                title: "Harare"
                              }));
                            }

                            cluster = new MarkerClusterer(map, markers);
                        }
                    
                      /*var infowindow = new google.maps.InfoWindow({
                            content:"Gweru"
                        });
                        infowindow.open(map,marker);*/
                        function toggleLevels(i) {
                          if(levels[i].getMap() === null) {
                            levels[i].setMap(map);
                          }
                          else {
                            levels[i].setMap(null);
                          }
                        }
                    </script>
				</div>
			</div>
		</div>
		{% else %}
		<table class="table table-striped table-bordered table-hover">
			<tr class="warning">
				<td style="text-align:center">No Data Available</td>
			</tr>
		</table>
		{% endif %}
	</div>
</div>
{% endblock %}

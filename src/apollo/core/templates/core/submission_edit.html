{% extends "core/layout.html" %}
{% load apollo %}{% load comments %}{% load humanize %}{% load static %}{% load i18n %}
{% block title %}
{{ page_title }}
<style type="text/css">
  .added {border-right:3px solid green;}
  .deleted {border-right:3px solid red;}
  .changed {border-right:3px solid #c09853;}
</style>
{% if perms.core.can_analyse %}
{% if versions %}
<div class="btn-group pull-right">
  {% if submission_version %}
  <a class="btn" href="">{{ submission_version.revision.date_created|naturaltime }}<em> — {{ submission_version.revision.user|default_if_none:_('SMS') }}</em></a>
  {% else %}
  <a class="btn" href="">{% trans "History" %}</a>
  {% endif %}
  <button class="btn dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>
  <ul class="dropdown-menu">
  {% if submission_version %}
    <li>
      <a href="{% url submission_edit submission.pk %}">{% trans "now" %}</a>
    </li>
  {% endif %}
    {% for version in versions %}
    <li>
      <a href="{% url submission_edit_with_version submission.pk version.pk %}">{{ version.revision.date_created|naturaltime }}<em> — {{ version.revision.user|default_if_none:_('SMS') }}</em></a>
    </li>
    {% endfor %}
  </ul>
</div>
{% endif %}
{% endif %}
{% endblock %}
{% block content %}
  {% with submission.siblings as siblings %}
  <form action="" method="post" style="margin-bottom:.5em;">
    {% csrf_token %}
  <div class="row">
    <div class="span12">
      <table class="table table-bordered">
        <thead>
          {% if submission.form.type == 'CHECKLIST' %}
          <tr>
            <th width="15%">&nbsp;</th>
            <th>1</th>
            {% for sibling in siblings %}
            <th>{{ forloop.counter|add:"1" }}</th>
            {% endfor %}
          </tr>
          {% endif %}
          <tr>
            <th>{% trans "Observer" %}</th>
            <td><strong>{{ submission.observer.observer_id }}</strong> &mdash; <strong>{{ submission.observer.name }}</strong>{% if submission.observer.phone %} ({{ submission.observer.phone }}){% endif %}</td>
            {% if submission.form.type == 'CHECKLIST' %}
            {% for sibling in siblings %}
            <td><strong>{{ sibling.observer.name }}</strong>{% if sibling.observer.phone %} ({{ sibling.observer.phone }}){% endif %} &mdash; <strong>{{ sibling.observer.observer_id }}</strong></td>
            {% endfor %}
            {% endif %}
          </tr>
          <tr>
            <th>{% trans "Role" %}</th>
            <td>{{ submission.observer.role }}</td>
            {% if submission.form.type == 'CHECKLIST' %}
            {% for sibling in siblings %}
            <td>{{ sibling.observer.role }}</td>
            {% endfor %}
            {% endif %}
          </tr>
          <tr>
            <th>{% trans "Phone" %}</th>
            <td><em>{% if submission.observer.last_connection %}{{ submission.observer.last_connection.identity }}{% else %}{{ submission.observer.phone }}{% endif %}</em>
              {% with submission.observer.phone|slugify as known_number %}{% with submission.observer.last_connection.identity|slugify|default:known_number as texting_number %} <img src="{% if texting_number == known_number %}{% static "img/tick.png" %}{% else %}{% static "img/caution.png" %}{% endif %}" style="vertical-align:text-bottom" />{% endwith %}{% endwith %}</td>
            {% if submission.form.type == 'CHECKLIST' %}
            {% for sibling in siblings %}
            <td><em>{% if sibling.observer.last_connection %}{{ sibling.observer.last_connection.identity }}{% else %}{{ sibling.observer.phone }}{% endif %}</em>
              {% with sibling.observer.phone|slugify as known_number %}{% with sibling.observer.last_connection.identity|slugify|default:known_number as texting_number %} <img src="{% if texting_number == known_number %}{% static "img/tick.png" %}{% else %}{% static "img/caution.png" %}{% endif %}" style="vertical-align:text-bottom" />{% endwith %}{% endwith %}</td>
            {% endfor %}
            {% endif %}
          </tr>
          {% if submission.form.type == 'CHECKLIST' %}
          <tr>
            <th>{% trans "Location" %}</th>
            <td><strong>{{ submission.location }}</strong></td>
            {% for sibling in siblings %}
            <td><strong>{{ sibling.location }}</strong></td>
            {% endfor %}
          </tr>
          {% if location_types %}
          <tr>
            <th>&nbsp;</th>
            <td>{% for location_type in location_types %}{% get_location_for_type submission location_type "True" %}{% if not forloop.last %} / {% endif %}{% endfor %}</td>
            {% for sibling in siblings %}
            <td>{% for location_type in location_types %}{% get_location_for_type sibling location_type "True" %}{% if not forloop.last %} / {% endif %}{% endfor %}</td>
            {% endfor %}
          </tr>
          {% endif %}
          {% else %}
          <tr>
            <th>{% trans "Location" %}</th>
            <td>{{ form.location }}</td>
          </tr>
          {% if location_types %}
          <tr>
            <th>&nbsp;</th>
            <td>{% for location_type in location_types %}{% get_location_for_type submission location_type "True" %}{% if not forloop.last %} / {% endif %}{% endfor %}</td>
          </tr>
          {% endif %}
          {% if form.data__location.value %}
          <tr>
            <th>{% trans "Texted Location" %}</th>
            <td><strong><em>{{ form.data__location.value }}</em></strong>{{ form.data__location }}</td>
          </tr>
          {% endif %}
          {% endif %}
          {% if submission.form.type == 'CHECKLIST' %}
          <tr>
            <th>{% trans "Supervisor" %}</th>
            <td>{{ submission.observer.supervisor|default_if_none:"<em>N/A</em>" }}</td>
            {% if submission.form.type == 'CHECKLIST' %}
            {% for sibling in siblings %}
            <td>{{ sibling.observer.supervisor|default_if_none:"<em>N/A</em>" }}</td>
            {% endfor %}
            {% endif %}
          </tr>
          {% endif %}
        </thead>
      </table>
      {% if submission.form.type == 'CHECKLIST' %}
      <table class="table table-striped table-bordered table-hover submission-table">
        <tbody>
          <tr>
            <td colspan="2">&nbsp;</td>
            <td style="text-align:center"><strong>1</strong></td>
            {% for sibling in siblings %}
            <td style="text-align:center"><strong>{{ forloop.counter|add:"1" }}</strong></td>
            {% endfor %}
            <td>{{ form.data__verification }}&nbsp;</td>
          </tr>
          {% for fieldset in form.fieldsets %}
          {% if fieldset.legend %}
          <tr>
            <td colspan="{{ siblings.count|add:"4" }}"><h4 class="{{ fieldset.classes }}">{{ fieldset.legend }}</h4></td>
          </tr>
          {% endif %}
          {% for field in fieldset %}
          <tr{% if field.label in object.overrides %} class="warning"{% endif %}>
            <td>{{ field.label }}</td>
            <td>{{ field.help_text }}
              {% if field.field.choices %}
              <span class="options">
                {% for choice in field.field.choices %}
                <span class="option"><strong>({{ choice.0 }})</strong> {{ choice.1 }}</span>
                {% endfor %}
              </span>
              {% endif %}
            </td>
            {% if submission_diff %}
              {% if field.label in submission_diff.0 %}
                <td class="submission-field added" title="{% trans 'Added' %}">{{ submission_form|keyvalue:field.name }}</td>
              {% elif field.label in submission_diff.1 %}
                <td class="submission-field deleted" title="{% trans 'Deleted' %}">{{ submission_form|keyvalue:field.name }}</td>
              {% elif field.label in submission_diff.2 %}
                <td class="submission-field changed" title="{% trans 'Changed' %}">{{ submission_form|keyvalue:field.name }}</td>
              {% else %}
                <td class="submission-field">{{ submission_form|keyvalue:field.name }}</td>
              {% endif %}
            {% else %}
            <td class="submission-field">{{ submission_form|keyvalue:field.name }}</td>
            {% endif %}
            {% for sibling in submission_sibling_forms %}
            <td class="submission-field">{{ sibling|keyvalue:field.name }}</td>
            {% endfor %}
            {% if master_diff %}
              {% if field.label in master_diff.0 %}
              <td class="submission-field added" title="{% trans 'Added' %}">{{ field }}</td>
              {% elif field.label in master_diff.1 %}
              <td class="submission-field deleted" title="{% trans 'Deleted' %}">{{ field }}</td>
              {% elif field.label in master_diff.2 %}
              <td class="submission-field changed" title="{% trans 'Changed' %}">{{ field }}</td>
              {% else %}
              <td class="submission-field">{{ field }}</td>
              {% endif %}
            {% else %}
            <td class="submission-field">{{ field }}</td>
            {% endif %}
          </tr>
          {% endfor %}
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <table class="table table-striped table-bordered table-hover" style="margin-bottom:5.5em;">
        <tbody>
          <tr>
            <td colspan="2">&nbsp;</td>
            <td>&nbsp;</td>
          </tr>
          {% for fieldset in form.fieldsets %}
          {% if fieldset.legend %}
          <tr>
            <td colspan="3"><h4 class="{{ fieldset.classes }}">{{ fieldset.legend }}</h4></td>
          </tr>
          {% endif %}
          {% for field in fieldset %}
          <tr{% if field.label in object.overrides %} class="warning"{% endif %}>
            <td style="text-align: center">{{ field.label }}</td>
            <td width="100%"><label for="{{ field.auto_id }}">{{ field.help_text }}
              {% if field.field.choices %}
              <span class="options">
                {% for choice in field.field.choices %}
                <span class="option"><strong>({{ choice.0 }})</strong> {{ choice.1 }}</span>
                {% endfor %}
              </span>
              {% endif %}</label>
            </td>
            <td style="text-align:center">{{ field }}</td>
          </tr>
          {% endfor %}
          {% endfor %}
          <tr>
            <td style="text-align: right">{% trans "Witness" %}</td>
            <td colspan="2">{{ form.data__witness }}</td>
          </tr>
          <tr>
            <td style="text-align: right">{% trans "Description" %}</td>
            <td colspan="2">{{ form.data__description }}</td>
          </tr>
          <tr>
            <td style="text-align: right">{% trans "Status" %}</td>
            <td colspan="2">{{ form.data__status }}</td>
          </tr>
        </tbody>
      </table>
      {% endif %}
    </div>
  </div>
{% if not submission_version %}
  <div class="row navbar-fixed-bottom" style="bottom:0px; margin-left:1.75em; background:#fff; padding-top:1em; padding-bottom:1em;">
    <div class="offset8 span2">
      <button type="submit" class="btn btn-info btn-large btn-block">{% trans "Save" context "verb" %}</button>
    </div>
    <div class="span2">
      <a class="btn btn-large btn-block" href="{% url submissions_list object.form.pk %}">{% trans "Cancel" context "verb" %}</a>
    </div>
  </div>
{% endif %}
  </form>
{% endwith %}

{% if submission.form.type == 'CHECKLIST' %}
<div class="row">
  <div class="span12">
    <table class="table table-striped table-bordered" id="comments" style="margin-bottom:5.5em;">
      {% get_comment_list for submission as comments %}
      {% for comment in comments %}
      <tr>
        <td>
          <p><strong>{{ comment.user_name }}</strong> · <em>{{ comment.submit_date|naturaltime }}</em></p>
          <p>{{ comment.comment }}</p>
        </td>
      </tr>
      {% empty %}
      <tr class="warning">
        <td style="text-align:center">{% trans "No comment." %}</td>
      </tr>
      {% endfor %}
      <tr id="save_comment">
        <td>
            <textarea id="comment" style="width:98.5%"></textarea>
            <input type="hidden" id="submission" name="submission" value="{{ submission.pk }}" />
            <input id="save" type="button" value="{% trans 'Add Comment' %}" class="btn btn-primary pull-right" />
            <div id="loader" class="ajax_loader pull-right" style="visibility: hidden">
              <div class="ajax_loader_block block_1"></div>
              <div class="ajax_loader_block block_2"></div>
              <div class="ajax_loader_block block_3"></div>
            </div>
        </td>
      </tr>
    </table>
  </div>
</div>
{% endif %}
{% endblock %}
{% block javascripts %}
{{ block.super }}
<script type="text/javascript">
  $('#save').click(function () {
    var comment = $('#comment').val(), submission = $('#submission').val();
    if (comment) {
      $.ajax({
        url: "{% url add_comment %}",
        type: 'POST',
        data: {comment: comment, submission: submission},
        beforeSend: function (xhr) {
          $('#comment').attr('disabled', 'disabled');
          $('#save').attr('disabled', 'disabled');
          $('#loader').attr('style', 'visibility:visible;');
        }
      })
      .done(function (data) {
        // clear the value in the comment box
        $('#comment').val("");
        // if there's a table row displaying "No comment.", remove it
        $('#comments tr.warning').remove();
        $('#save_comment').before('<tr><td><p><strong>' + data.username + '</strong> · <em>' + data.date + '</em></p><p>' + data.comment + '</p></td></tr>');
      })
      .always(function () {
        // Re-enable
        $('#comment').removeAttr('disabled');
        $('#save').removeAttr('disabled');
        $('#loader').attr('style', 'visibility:hidden;');
      });  
    }
  });
</script>
{% endblock %}
